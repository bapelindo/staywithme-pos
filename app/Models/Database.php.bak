<?php
// File: app/Models/Database.php

namespace App\Models;

use PDO;
use PDOException;

/**
 * Class Database (Singleton Pattern)
 *
 * Mengelola koneksi database PDO tunggal untuk seluruh aplikasi,
 * membaca konfigurasi dari file config/config.php.
 */
class Database {
    /**
     * @var Database|null Instance tunggal dari kelas Database.
     */
    private static ?Database $instance = null;

    /**
     * @var PDO|null Objek koneksi PDO.
     */
    private ?PDO $conn = null;

    /**
     * Constructor private untuk mencegah pembuatan instance langsung.
     * Membuat koneksi PDO saat instance pertama kali dibuat.
     */
    private function __construct() {
        // Muat konfigurasi dari file config.php
        // Path relatif dari app/Models/ ke config/
        $configPath = __DIR__ . '/../../config/config.php';

        if (!file_exists($configPath)) {
             // Handle jika file konfigurasi tidak ditemukan
             error_log("Error: File konfigurasi tidak ditemukan di {$configPath}");
             die("Kesalahan konfigurasi sistem. File konfigurasi tidak ditemukan.");
        }

        // require_once memastikan file hanya dimuat sekali
        $config = require_once($configPath);

        // Periksa apakah konfigurasi database ada
        if (!isset($config['database'])) {
            error_log("Error: Konfigurasi database tidak ditemukan dalam file config.php.");
            die("Kesalahan konfigurasi sistem. Konfigurasi database tidak lengkap.");
        }

        $dbConfig = $config['database'];

        // Ambil detail koneksi dari array config
        $host     = $dbConfig['host'] ?? 'localhost'; // Gunakan default jika tidak diset
        $db_name  = $dbConfig['dbname'] ?? '';
        $username = $dbConfig['user'] ?? 'root';
        $password = $dbConfig['password'] ?? '';
        $charset  = $dbConfig['charset'] ?? 'utf8mb4';

        if (empty($db_name)) {
             error_log("Error: Nama database (dbname) tidak diset dalam config.php.");
             die("Kesalahan konfigurasi sistem. Nama database belum diatur.");
        }

        // Buat DSN (Data Source Name)
        $dsn = "mysql:host={$host};dbname={$db_name};charset={$charset}";
        $options = [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES   => false,
        ];

        try {
            $this->conn = new PDO($dsn, $username, $password, $options);
        } catch (PDOException $e) {
            error_log("Koneksi Database Gagal: " . $e->getMessage());
            die("Mohon maaf, terjadi masalah saat menghubungkan ke basis data. Silakan coba lagi nanti.");
        }

        // Set timezone aplikasi jika diset di config
        if (isset($config['app']['timezone'])) {
             date_default_timezone_set($config['app']['timezone']);
        }
    }

    /**
     * Mendapatkan instance tunggal dari kelas Database.
     *
     * @return Database Instance Database.
     */
    public static function getInstance(): Database {
        if (self::$instance === null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }

    /**
     * Mendapatkan objek koneksi PDO yang aktif.
     *
     * @return PDO|null Objek PDO jika koneksi berhasil.
     */
    public function getConnection(): ?PDO {
        return $this->conn;
    }

    /** Mencegah instance di-clone */
    private function __clone() {}

    /** Mencegah instance di-unserialize */
    public function __wakeup() {
         throw new \Exception("Cannot unserialize a singleton.");
    }
}
?>